global
        log 127.0.0.1   local0
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

	ssl-default-bind-options no-sslv3
	ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS

	ssl-default-server-options no-sslv3
	ssl-default-server-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS

defaults
	log	global
	mode	http
	option	httplog
	option	dontlognull
        timeout connect 5000
        timeout client  50000
        timeout server  50000
	errorfile 400 /etc/haproxy/errors/400.http
	errorfile 403 /etc/haproxy/errors/403.http
	errorfile 408 /etc/haproxy/errors/408.http
	errorfile 500 /etc/haproxy/errors/500.http
	errorfile 502 /etc/haproxy/errors/502.http
	errorfile 503 /etc/haproxy/errors/503.http
	errorfile 504 /etc/haproxy/errors/504.http

frontend tornotmyidea
	bind 127.0.0.1:9999
	default_backend nginx_server
 
frontend https
	bind 0.0.0.0:443 ssl no-sslv3 crt /etc/ssl/letsencrypt
	mode http
	default_backend nginx_server

        acl     fourmilieres_redirect hdr_beg(host) -i fourmilieres.net
        redirect        location        https://www.fourmilieres.net       code 301        if fourmilieres_redirect

        acl     notmyidea_redirect hdr_beg(host) -i notmyidea.org
        acl     notmyidea_redirect hdr_beg(host) -i www.notmyidea.org
        redirect        location        https://blog.notmyidea.org       code 301        if notmyidea_redirect

	acl     host_discourse_server   hdr_beg(host) -i forum.
	use_backend     discourse_server    if host_discourse_server

	acl     host_shout_notmyidea   hdr_beg(host) -i shout.notmyidea.org
	use_backend     shout_notmyidea    if host_shout_notmyidea

	acl     host_git_notmyidea   hdr_beg(host) -i git.notmyidea.org
	use_backend     git_notmyidea    if host_git_notmyidea

	acl     host_pad   hdr_beg(host) -i pad.
	use_backend     pad    if host_pad

	acl     host_board_notmyidea   hdr_beg(host) -i board.
	use_backend     wekan_notmyidea    if host_board_notmyidea

	acl     host_torrents_notmyidea   hdr_beg(host) -i torrents.notmyidea.org
	use_backend     torrents_notmyidea    if host_torrents_notmyidea

	acl     host_kinto   hdr_beg(host) -i kinto.
	use_backend     kinto    if host_kinto 

	acl     host_kinto_slack   hdr_beg(host) -i slack.kinto-storage.org
	use_backend     kinto_slack    if host_kinto_slack

	acl     host_zimit   hdr_beg(host) -i zimit.notmyidea.org
	use_backend     zimit_server    if host_zimit 



frontend http
	bind 0.0.0.0:80
	mode http
	default_backend nginx_server

	acl letsencrypt_check path_beg /.well-known/acme-challenge
	use_backend letsencrypt_backend if letsencrypt_check

        acl     notmyidea_redirect hdr_beg(host) -i notmyidea.org
        acl     notmyidea_redirect hdr_beg(host) -i www.notmyidea.org
        redirect        location        https://blog.notmyidea.org       code 301        if notmyidea_redirect
        acl     fourmilieres_redirect hdr_beg(host) -i fourmilieres.net
        acl     fourmilieres_redirect hdr_beg(host) -i www.fourmilieres.net
        redirect        location        https://www.fourmilieres.net       code 301        if fourmilieres_redirect

	acl     host_board_notmyidea   hdr_beg(host) -i board.
	use_backend     wekan_notmyidea    if host_board_notmyidea

	acl     host_discourse_server   hdr_beg(host) -i forum.
	use_backend     discourse_server    if host_discourse_server

	acl     do_not_redirect   hdr_beg(host) -i pierre.
	acl     do_not_redirect   hdr_beg(host) -i www.samuelgenin.fr
	acl     do_not_redirect   hdr_beg(host) -i ihatemoney.org
	redirect scheme https code 301 if !{ ssl_fc } !letsencrypt_check !notmyidea_redirect !fourmilieres_redirect !do_not_redirect


backend git_notmyidea
	mode http
	dispatch 127.0.0.1:3000

backend discourse_server
	mode http
	dispatch 127.0.0.1:9001

backend shout_notmyidea
	mode http
	dispatch 127.0.0.1:9003

backend pad
	mode http
	dispatch 127.0.0.1:9004

backend wekan_notmyidea
	mode http
	dispatch 127.0.0.1:9005

backend zimit_server
	mode http
	dispatch 127.0.0.1:6543

backend torrents_notmyidea
	mode http
	dispatch 127.0.0.1:9006

backend kinto 
	mode http
	dispatch 127.0.0.1:9007

backend kinto_slack
	mode http
	dispatch 127.0.0.1:9008

backend letsencrypt_backend
   	http-request set-header Host letsencrypt.requests
	dispatch 127.0.0.1:8000

backend nginx_server
	mode http
	dispatch 127.0.0.1:8000
